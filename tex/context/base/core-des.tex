%D \module
%D   [       filefile=core-des,
%D        version=1997.03.31,
%D          title=\CONTEXT\ Core Macros,
%D       subtitle=Descriptions,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA / Hans Hagen \& Ton Otten}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\writestatus{loading}{Context Core Macros / Descriptions}

\unprotect

% Dit kan en moet dus anders:
%
% \start... :  \vbox\bgroup
% \stop...  :  \egroup
% llap enz.
% geen indent!
%
% enz. enz.
%
% Op die manier is meer mogelijk en worden \par's geskipt.
%
% De macro \??dd#1\s!do\c!commando levert de koppeling tussen
% \doornummeren en \doordefinieren. Deze constructie is nodig
% omdat doornummeren geen argument heeft en omdat subnummers
% niet worden genest binnen het hogere niveau. Het commando
% \??dd#1\s!do\c!state moet in dat geval \v!start zijn.
%
% herimplementeren met \nextbox en \unhbox\unvbox

\newbox\@@definitiebox

\def\@@definitiewoord#1%
  {\getvalue{\??dd#1\s!do\c!command}{#1}}

% \def\normal@@definitiewoord#1[#2]#3#4%
%   {\doattributes
%      {\??dd#1}\c!kopletter\c!kopkleur
%      {\getvalue{\??dd#1\c!commando}% NAAR BUITENSTE NIVEAU !
%         {\begstrut\getvalue{\??dd#1\c!tekst}#4\endstrut}}%
%    \rawreference\s!def{#2}{#3}}

\def\normal@@definitiewoord#1[#2]#3#4%
  {\doattributes
     {\??dd#1}\c!headstyle\c!headcolor
     {\getvalue{\??dd#1\c!command}{#4}}% NAAR BUITENSTE NIVEAU !
   \rawreference\s!def{#2}{#3}} % brrr moet in #4

\setvalue{@@definitie\v!left}#1%
  {\@@definitiehang{#1}\@@definitielinkspure\@@definitielinkshang}

\setvalue{@@definitie\v!right}#1%
  {\@@definitiehang{#1}\@@definitierechtspure\@@definitierechtshang}

\def\@@definitiehang#1#2#3%
  {\processaction
     [\getvalue{\??dd#1\c!hang}]
     [   \v!none=>\let\next#2,%
               0=>\let\next#2,%
      \s!unknown=>\let\next#3,%
      \s!default=>\let\next#2]%
   \next{#1}}

\def\@@definitielinkspure#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}%
   \noindent\ignorespaces
   \leftskip\@@leftdefinitieskip
   \rightskip\@@rightdefinitieskip
   \advance\leftskip \!!widtha
   \@@makedefinitiepurebox{#1}\raggedright
   \advance\leftskip \!!widthb
   \llap
     {\hbox to \leftskip
        {\hskip\@@leftdefinitieskip
         \copy\@@definitiebox\hss}}%
   \@@dodefinitie{#1}}

\def\@@definitierechtspure#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}%
   \noindent\ignorespaces
   \leftskip\@@leftdefinitieskip
   \rightskip\@@rightdefinitieskip
   \advance\rightskip \!!widtha
   \@@makedefinitiepurebox{#1}\raggedleft
   \rlap
     {\hskip\hsize
      \hskip-\leftskip
      \hskip-\rightskip
      \copy\@@definitiebox
      \hskip\@@rightdefinitieskip}%
   \advance\rightskip \!!widthb
   \@@dodefinitie{#1}}

\def\@@makedefinitiepurebox#1#2%
  {\setbox\@@definitiebox\vtop
     {\dontcomplain
      \hsize\!!widtha
      \leftskip\zeropoint
      \rightskip\zeropoint
      #2\setupalign[\getvalue{\??dd#1\c!align}]%
      \ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox}%
   \ht\@@definitiebox\strutht
   \dp\@@definitiebox\strutdp}

\def\@@definitielinkshang#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}%
   \dontcomplain
   \advance\!!widtha \!!widthb
   \hangindent\!!widtha
   \@@makedefinitiehangbox{#1}\raggedright{\advance\rightskip \!!widthb}%
   \noindent\ignorespaces
   \llap
     {\dontshowcomposition
      \vtop to \zeropoint{\box\@@definitiebox}}%
   \@@dodefinitie{#1}}%

\def\@@definitierechtshang#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}%
   \dontcomplain
   \advance\!!widtha \!!widthb
   \hangindent-\!!widtha
   \@@makedefinitiehangbox{#1}\raggedleft{\advance\leftskip \!!widthb}%
   \noindent\ignorespaces
   \rlap
     {\dontcomplain
      \dontshowcomposition
      \dimen0=\hsize
      \advance\dimen0 -\leftskip
      \advance\dimen0 -\rightskip
      \hbox to \dimen0
        {\hss\vtop to \zeropoint{\box\@@definitiebox}}}%
   \@@dodefinitie{#1}}

\def\@@makedefinitiehangbox#1#2#3%
  {\setbox\@@definitiebox\vtop % \vbox gaat fout in hang
     {\forgetall
      \dontcomplain
      \hsize\!!widtha
      #2\setupalign[\getvalue{\??dd#1\c!align}]#3%
      \ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox}%
   \ht\@@definitiebox\strutht
   \dp\@@definitiebox\strutdp
   \doifinsetelse{\getvalue{\??dd#1\c!hang}}{\v!fit,\v!broad}
     {\dimen0=\ht\@@definitiebox
      \advance\dimen0 \dp\@@definitiebox
      \doifvalue{\??dd#1\c!hang}\v!broad
        {\advance\dimen0 .5\strutht}%
      \getnoflines{\dimen0}%
      \hangafter-\noflines}
     {\hangafter-\getvalue{\??dd#1\c!hang}}}%

\setvalue{@@definitie\v!top}#1[#2]#3%
  {%\page[\v!preference]%       % Weg ermee!
   %\dosomebreak{\goodbreak}%   % Dit is beter en nodig!
   \dohandelpaginaafX1          % En dit moet het maar worden.
   \@@dostartdefinitie{#1}[#2]{\let\\=\space#3}%
   \noindent\ignorespaces
   \copy\@@definitiebox\par
   \nobreak
   \getvalue{\??dd#1\c!inbetween}%
   \nobreak
   \@@dodefinitie{#1}}

% \setvalue{@@definitie\v!inmarge}#1[#2]#3%
%   {\@@dostartdefinitie{#1}[#2]{#3}%
%    \noindent\ignorespaces
%    \inmargin{\ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox}%
%    \@@dodefinitie{#1}}
%
% \setvalue{@@definitie\v!inlinker}#1[#2]#3%
%   {\@@dostartdefinitie{#1}[#2]{#3}%
%    \noindent\ignorespaces
%    \inleft{\ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox}%
%    \@@dodefinitie{#1}}
%
% \setvalue{@@definitie\v!inrechter}#1[#2]#3%
%   {\@@dostartdefinitie{#1}[#2]{#3}%
%    \noindent\ignorespaces
%    \inright{\ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox}%
%    \@@dodefinitie{#1}}

\def\do@@definitie#1#2[#3]#4%
  {\@@dostartdefinitie{#2}[#3]{#4}%
   \noindent\ignorespaces
   #1{\ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox}%
   \@@dodefinitie{#2}}

\setvalue{@@definitie\v!inmargin     }{\do@@definitie\inmargin}
\setvalue{@@definitie\v!inleft    }{\do@@definitie\inleft  }
\setvalue{@@definitie\v!inright   }{\do@@definitie\inright }
\setvalue{@@definitie\v!margin       }{\do@@definitie\inmargin}
\setvalue{@@definitie\v!leftmargin }{\do@@definitie\inleft  }
\setvalue{@@definitie\v!rightmargin}{\do@@definitie\inright }
\setvalue{@@definitie\v!innermargin }{\do@@definitie\ininner}
\setvalue{@@definitie\v!outermargin }{\do@@definitie\inouter}

\setvalue{@@definitie\v!serried\v!fit}#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}%
   \noindent\ignorespaces
   \ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox
   \hskip\!!widthb % toegevoegd
   \@@dodefinitie{#1}}

\setvalue{@@definitie\v!serried\v!broad}#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}%
   \noindent\ignorespaces
   \ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox
   \hskip\!!widthb \!!plus .5\!!widthb \!!minus .25\!!widthb
   \@@dodefinitie{#1}}

\setvalue{@@definitie\v!serried\v!wide}#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}%
   \noindent\ignorespaces
   \hbox to \!!widtha
     {\ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox\hss}%
   \hskip\!!widthb
   \ignorespaces
   \@@dodefinitie{#1}}

\setvalue{@@definitie\v!serried}#1[#2]#3%
  {\processaction
      [\getvalue{\??dd#1\c!width}]
      [\v!fit=>\let\next\v!fit,
          \v!broad=>\let\next\v!broad,
       \s!unknown=>\let\next\v!wide,
       \s!default=>\let\next\v!broad]%
   \getvalue{@@definitie\v!serried\next}{#1}[#2]{#3}}

\setvalue{@@definitie\v!hanging}#1[#2]#3%
  {\@@dostartdefinitie{#1}[#2]{#3}% % adds \c!margin to \leftskip
   \noindent\ignorespaces
   \advance\leftskip -\leftskipadaption \relax
   \ifdim\leftskipadaption=\zeropoint
     \leftskipadaption1.5em % just some default
     \ifnum\insidedefinition=\plusone
       \ifdim\leftskip>\zeropoint \relax
         \leftskipadaption\leftskip
       \fi
     \fi
   \fi
   \ifnum\insidedefinition=\plusone
     \advance\leftskip \leftskipadaption
   \fi
   \hskip-\leftskipadaption
   \ifhbox\@@definitiebox\unhcopy\else\copy\fi\@@definitiebox
   \ifdim\!!widthb=\zeropoint
     \kern.75em                     % another default
   \else
     \kern\!!widthb
   \fi
   \ignorespaces
   \@@dodefinitie{#1}}

%D A bonus definition
%D
%D \starttyping
%D \setupfootnotedefinition[location=command,headcommand=\llap]
%D \stoptyping

\setvalue{@@definitie\v!command}#1%
  {\do@@definitie{\executeifdefined{\??dd#1\c!headcommand}\framed}{#1}}

%D A new key 'titeluitlijnen' in definitions.

\chardef\insidedefinition=0

\let\@@leftdefinitieskip \!!zeropoint
\let\@@rightdefinitieskip\!!zeropoint

\def\@@dostartdefinitie#1[#2]#3%
  {\getvalue{\??dd#1\c!before}%
   \begingroup
   \doadaptleftskip{\getvalue{\??dd#1\c!margin}}%
   \showcomposition
   \!!widthb\getvalue{\??dd#1\c!distance}\relax
   \ifdim\!!widthb=\zeropoint\relax
     \doifvalue{\??dd#1\c!width}\v!broad{\!!widthb=1em}%
   \fi
   % temp hack, we need to avoid this kind of preprocessing
   \setbox\@@definitiebox\hbox % preroll
     {\forgetall
      \trialtypesettingtrue
      \dontcomplain
      \def\\{\crlf}%
      \@@definitiewoord{#1}[#2]{#3}%
        {\begstrut\getvalue{\??dd#1\c!text}\ignorespaces#3\endstrut}}%
   % so far
   \assignwidth
     {\!!widtha}%
     {\getvalue{\??dd#1\c!width}}%
     {\doifelsevaluenothing{\??dd#1\c!sample}%
        {% preroll can move here (test first)
         \ifhbox\@@definitiebox\unhcopy\else\copy\fi \@@definitiebox}%
        {\@@definitiewoord{#1}[#2]{#3}%
           {\getvalue{\??dd#1\c!text}\getvalue{\??dd#1\c!sample}}}}
     {\!!widthb}%
   \setbox\@@definitiebox\hbox
     {\forgetall
      \dontcomplain
      \let\\\endgraf
      \doifelsevalue{\??dd#1\c!location}\v!serried
        {\@@definitiewoord{#1}[#2]{#3}%
           {\begstrut\getvalue{\??dd#1\c!text}#3\endstrut}}
        {\@@definitiewoord{#1}[#2]{#3}%
           {\vtop{\hsize\!!widtha\advance\hsize-\!!widthb
            \begstrut\getvalue{\??dd#1\c!text}\ignorespaces#3\endstrut}}}}%
   \doifelsevalue{\??dd#1\c!aligntitle}\v!no
     {\edef\@@leftdefinitieskip {\the\leftskip }%
      \edef\@@rightdefinitieskip{\the\rightskip}}
     {\ifcase\insidedefinition
        \edef\@@leftdefinitieskip {\the\leftskip }%
        \edef\@@rightdefinitieskip{\the\rightskip}%
      \fi}%
   \expanded{\indenting[\getvalue{\??dd#1\c!indenting}]}%
   \ifcase\insidedefinition % better a system mode
     \chardef\insidedefinition\plusone
   \or
     \chardef\insidedefinition\plustwo
   \fi} % now happens elsewhere : \noindent\ignorespaces

\def\@@stopdefinitie#1%
  {\par % maybe better after \dostopattributes
   \dostopattributes
   \endgroup
   \getvalue{\??dd#1\c!after}%
   \egroup % temporary hack
   \dochecknextindentation{\??dd#1}}

\def\@@dodefinitie#1%
  {\dostartattributes{\??dd#1}\c!style\c!color\empty
   \ignorespaces}

% \def\@@somedefinitie#1[#2]#3%
%   {\bgroup % temporary hack
%    \BeforePar{\executedoordefinitie{#1}[#2]{#3}}%
%    \AfterPar{\@@stopdefinitie{#1}}%
%    \GetPar}
%
% nicer and better:

\def\@@somedefinitie#1[#2]#3%
  {\dowithpar
     {\bgroup\executedoordefinitie{#1}[#2]{#3}}%
     {\@@stopdefinitie{#1}}}

\def\@@startsomedefinitie#1[#2]#3%
  {\bgroup % temporary hack
   \BeforePar{\executedoordefinitie{#1}[#2]{#3}}%
   \GotoPar}

\def\dodosetupdescriptions[#1][#2]%
  {\getparameters[\??dd#1][#2]}

\def\dosetupdescriptions[#1][#2]% % beter: \iffirstargument
  {\ConvertToConstant\doifelse{#2}{}
     {\dodosetupdescriptions[][#1]}
     {\dodoubleargumentwithset\dodosetupdescriptions[#1][#2]}}

\def\setupdescriptions%
  {\dodoubleempty\dosetupdescriptions}

\def\executedoordefinitie#1[#2]%
  {\ExpandAfter\doifundefined{@@definitie\getvalue{\??dd#1\c!location}}
     {\setvalue{\??dd#1\c!location}{\v!left}}%
   \getvalue{@@definitie\getvalue{\??dd#1\c!location}}{#1}[#2]}

\def\dodefinedescription[#1][#2]%
  {\copyparameters[\??dd#1][\??dd]
     [\c!location,\c!headstyle,\c!style,\c!color,\c!headcolor,
      \c!width,\c!hang,\c!sample,\c!before,\c!inbetween,\c!after,\c!margin,
      \c!indenting,\c!indentnext,\c!align,
      \c!text,\c!distance,\c!command]%
   \getparameters[\??dd#1]
     [\s!do\c!state=\v!stop,
      \s!do\c!command=\normal@@definitiewoord,
      #2]%
   \doifvalue{\??dd#1\c!location}\v!top
     {\doassign[\??dd#1][\c!inbetween={\blank}]}%
   \setvalue{#1}%
     {\dodoubleempty\@@definitie[#1]}%
   \setvalue{\e!start#1}%
     {\dodoubleempty\@@startdefinitie[#1]}%
   \setvalue{\e!stop#1}%
     {\@@stopdefinitie{#1}}}%

\def\@@startdefinitie[#1][#2]%
  {\doifelsevalue{\??dd#1\s!do\c!state}\v!start
     {\@@startsomedefinitie{#1}[#2]{}}
     {\dowithwargument{\@@startsomedefinitie{#1}[#2]}}}

\def\@@definitie[#1][#2]%
  {\doifelsevalue{\??dd#1\s!do\c!state}\v!start
     {\@@somedefinitie{#1}[#2]{}}
     {\dowithwargument{\@@somedefinitie{#1}[#2]}}}

\def\definedescription%
  {\dodoubleemptywithset\dodefinedescription}

\def\showdnpuretext#1%
  {\strut\getvalue{\??dd#1\c!text}} % geen spatie

% \def\showdntext#1%
%   {\doifelsevaluenothing{\??dd#1\c!tekst}
%      {\ignorespaces}
%      {\strut\getvalue{\??dd#1\c!tekst}\fixedspace}}

\def\showdntext#1%
  {\doifelsevaluenothing{\??dd#1\c!text}
     {\ignorespaces}
     {\strut
      \getvalue{\??dd#1\c!text}%
      \removeunwantedspaces\fixedspace}}

% \def\showdnnummer#1%
%   {\voorafgaandenummer
%    \convertednumber[\getvalue{\??dd#1\??dd\c!nummer}]}

\def\showdnnummer#1%
  {%\preparethenumber{\??dd#1}\voorafgaandenummer\preparednumber
   \preparednumber
   \convertednumber[\getvalue{\??dd#1\??dd\c!number}]}

\def\showdnsubnummer#1%
  {\showdnnummer{#1}%
   \getvalue{\??dd#1\c!separator}%
   \convertednumber[\v!sub\getvalue{\??dd#1\??dd\c!number}]}

\def\showdnsubsubnummer#1%
  {\showdnsubnummer{#1}%
   \getvalue{\??dd#1\c!separator}%
   \convertednumber[\v!sub\v!sub\getvalue{\??dd#1\??dd\c!number}]}

\def\showdnsubsubsubnummer#1%
  {\showdnsubsubnummer{#1}%
   \getvalue{\??dd#1\c!separator}%
   \convertednumber[\v!sub\v!sub\v!sub\getvalue{\??dd#1\??dd\c!number}]}

\def\domakednnummer#1#2#3%
  {\getvalue{\??dd#2#1\c!left}%
   \strut#3{#1}%
   \getvalue{\??dd#2#1\c!stopper}%
   \getvalue{\??dd#2#1\c!right}}

% #1=name  #2=level #3=\show  #4[#5]#6#7=#1[#2]#3#4 van definitie

\def\special@@definitiewoord#1#2#3#4[#5]#6#7%
  {\strut
   \doifelsevalue{\??dd#1\c!number}\v!no
     \!!doneafalse{\doifelse{#5}{-}\!!doneafalse\!!doneatrue}%
   \chardef\definitiekoppeling\zerocount
   \iflocation
     \doifvaluesomething{\??dd#1\c!coupling}
       {\processaction % genereert > of <
          [\getvalue{\??dd#1\c!couplingway}]
          [ \v!local=>\chardef\definitiekoppeling1, % old: default
           \v!global=>\chardef\definitiekoppeling2]}% new: global crosslinking
   \fi
   \setupnumber % the number is called indirectly
     [\getvalue{\??dd#1\??dd\c!number}]
     [\c!sectionnumber=\getvalue{\??dd#1\c!sectionnumber}]%
   \if!!donea
\iftrialtypesetting\startlocal\fi
     \getvalue{\e!next#2#1}% tricky but we need the preroll
\iftrialtypesetting\stoplocal\fi
     % \getvalue{\e!next#2#1}%
     \iflocation
       \bgroup
       \letvalue{\??dd#1\c!sectionnumber}\v!yes
       \protectconversion
       \maakvoorafgaandenummer[\getvalue{\??dd#1\??dd\c!number}]%
       \preparethenumber{\??dd#1}\voorafgaandenummer\preparednumber
       \ifcase\definitiekoppeling \or
         \xdef\internaldoornummer{#3{#1}}%
         \rawreference\s!num{#1:\internaldoornummer}{}%
       \or
         \xdef\internaldoornummer{\countervalue{\??dd\c!coupling#1}}%
         \rawreference\s!num{#1:\internaldoornummer}{}%
       \fi
       \egroup
     \fi
     \maakvoorafgaandenummer[\getvalue{\??dd#1\??dd\c!number}]%
     \preparethenumber{\??dd#1}\voorafgaandenummer\preparednumber
     \disablepseudocaps      % sorry, uppercase causes troubles
     \doattributes        % \nocase primitive needed
       {\??dd#1}\c!headstyle\c!headcolor
       {\getvalue{\??dd#1\c!command}% hook for taco
          {\showdntext{#2#1}%
           \domakednnummer{#1}{#2}{#3}}}%
     \iflocation\ifcase\definitiekoppeling \else
       \edef\localconnection{\getvalue{\??dd#1\c!coupling}:\internaldoornummer}%
       \doifreferencefoundelse\localconnection
         {\in[\localconnection]}\donothing % genereert > of <
     \fi\fi
     \doifnot{#5}{-}{\rawreference\s!num{#5}{#3{#1}}}%
   \else % Why was this strange expansion needed?
     \edef\!!stringa{\showdnpuretext{#2#1}}% nog eens testen binnen \expanded
     \expanded{\doattributes{\??dd#1}\noexpand\c!headstyle\noexpand\c!headcolor
       {\noexpand\getvalue{\??dd#1\c!command}{\!!stringa}}}%
     \doifnot{#5}{-}{\rawreference\s!num{#5}{}}%
   \fi}

\def\@@ddsetsubsubsubnummer#1%
  {\edef\doornummer{\getvalue{\??dd#1\??dd\c!number}}%
   \setnumber[\v!sub\v!sub\v!sub\doornummer]}

\def\@@ddsetsubsubnummer#1%
  {\@@ddresetsubsubsubnummer{#1}%
   \setnumber[\v!sub\v!sub\doornummer]}

\def\@@ddsetsubnummer#1%
  {\@@ddresetsubsubnummer{#1}%
   \setnumber[\v!sub\doornummer]}

\def\@@ddsetnummer#1%
  {\@@ddresetsubnummer{#1}%
   \setnumber[\doornummer]}

\def\@@ddresetsubsubsubnummer#1%
  {\edef\doornummer{\getvalue{\??dd#1\??dd\c!number}}%
   \resetnumber[\v!sub\v!sub\v!sub\doornummer]}

\def\@@ddresetsubsubnummer#1%
  {\@@ddresetsubsubsubnummer{#1}%
   \resetnumber[\v!sub\v!sub\doornummer]}

\def\@@ddresetsubnummer#1%
  {\@@ddresetsubsubnummer{#1}%
   \resetnumber[\v!sub\doornummer]}

\def\@@ddresetnumber#1%
  {\@@ddresetsubnummer{#1}%
   \resetnumber[\doornummer]}

\def\@@ddvolgendesubsubsubnummer#1[#2]%
  {\edef\doornummer{\getvalue{\??dd#1\??dd\c!number}}%
   \incrementnumber[\v!sub\v!sub\v!sub\doornummer]%
   \rawreference\s!num{#2}{\showdnsubsubsubnummer{\doornummer}}}%

\def\@@ddvolgendesubsubnummer#1[#2]%
  {\@@ddresetsubsubsubnummer{#1}%
   \incrementnumber[\v!sub\v!sub\doornummer]%
   \rawreference\s!num{#2}{\showdnsubsubnummer{\doornummer}}}

\def\@@ddvolgendesubnummer#1[#2]%
  {\@@ddresetsubsubnummer{#1}%
   \incrementnumber[\v!sub\doornummer]%
   \rawreference\s!num{#2}{\showdnsubnummer{\doornummer}}}

\def\@@ddvolgendenummer#1[#2]%
  {\@@ddresetsubnummer{#1}%
   \incrementnumber[\doornummer]%
   \rawreference\s!num{#2}{\showdnnummer{\doornummer}}}

\def\dodosetupenumerations[#1][#2]%
  {\getparameters[\??dd#1][#2]%
   \doifdefined{\??dd#1\c!start}
     {\setupnumber[#1][\c!start=\getvalue{\??dd#1\c!start}]}%
   \setupnumber[#1][\c!conversion=\getvalue{\??dd#1\c!conversion}]}

\def\dosetupenumerations[#1][#2]%
  {\ConvertToConstant\doifelse{#2}{}
     {\getparameters[\??dn][#1]}
     {\dodoubleargumentwithset\dodosetupenumerations[#1][#2]}}

\def\setupenumerations%
  {\dodoubleempty\dosetupenumerations}

\def\dododefineenumeration#1#2#3[#4][#5]#6%
  {\makecounter{\??dd\c!coupling#1}% new: global cross linking
   \dodefinedescription[#3#1]%
     [\s!do\c!state=\v!start,
      \s!do\c!command=\special@@definitiewoord{#1}{#3}{#6}]%
   \copyparameters[\??dd#3#1][\??dn]
     [\c!location,\c!headstyle,\c!style,\c!color,\c!headcolor,
      \c!width,\c!number,\c!distance,\c!command,
      \c!sample,\c!hang,\c!align,\c!before,\c!inbetween,\c!after,
      \c!levels,\c!way,\c!blockway,\c!separator,\c!margin,
      \c!indenting,\c!indentnext,\c!stopper,\c!sectionnumber,
      \c!number]%
   \doifassignmentelse{#4}
     {\getparameters[\??dd#3#1]%
        [\c!text=#1,\??dd\c!number=#1,\c!conversion=,
         \c!left=,\c!right=,\c!coupling=,\c!couplingway=\v!local,#4]}%
     {\doifelsenothing{#4}
        {\getparameters[\??dd#3#1]%
           [\c!text=#1,\??dd\c!number=#1,\c!conversion=,
            \c!stopper=,
            \c!left=,\c!right=,\c!coupling=,\c!couplingway=,#4]}%
        {\copyparameters[\??dd#3#1][\??dd#3#4]
           [\c!location,\c!headstyle,\c!style,\c!color,\c!headcolor,
            \c!width,\c!number,\c!distance,\c!command,\c!margin,
            \c!sample,\c!hang,\c!align,\c!before,\c!inbetween,\c!after,
            \c!stopper,\c!indenting,\c!indentnext,\c!left,\c!right,
            \c!coupling,\c!couplingway]%
         \getparameters[\??dd#3#1]
           [\c!text=#1,\??dd\c!number=#4,\c!conversion=,#5]}}%
   \ExpandBothAfter\doif{\getvalue{\??dd#3#1\??dd\c!number}}{#1}
     {\definenumber
        [#3#1]
        [\c!way=\getvalue{\??dd#1\c!way},
         \c!blockway=\getvalue{\??dd#1\c!blockway},
         \c!sectionnumber=\getvalue{\??dd#1\c!sectionnumber}]%
      \doifvalue{\??dd#1\c!levels}{#2}%                           % for
        {\doifsomething{\getvalue{\??dd#1\c!conversion}}%           % old
           {\setupnumber[#3#1]                                    % times
              [\c!conversion=\getvalue{\??dd#1\c!conversion}]}}}%    % sake
   \setvalue{\s!set#3#1}%
     {\dosetdoornummer[#1][#3]}%
   \setvalue{\s!reset#3#1}%
     {\doresetdoornummer[#1][#3]}%
   \setvalue{\e!next#3#1}%
     {\dotripleempty\dovolgendedoornummer[#1][#3]}}

\def\dovolgendedoornummer[#1][#2]%
  {\pluscounter{\??dd\c!coupling#1}% new: global crosslinking
   \getvalue{\??dd\c!next#2\c!number}{#1}}%

\def\doresetdoornummer[#1][#2]%
  {\getvalue{\??dd\s!reset#2\c!number}{#1}}%

\def\dosetdoornummer[#1][#2]%
  {\getvalue{\??dd\s!set#2\c!number}{#1}}%

\def\dodefineenumeration[#1][#2][#3]%
  {\dododefineenumeration{#1}{1}{}[#2][#3]\showdnnummer
   \dododefineenumeration{#1}{2}{\v!sub}[#2][#3]\showdnsubnummer
   \dododefineenumeration{#1}{3}{\v!sub\v!sub}[#2][#3]\showdnsubsubnummer
   \dododefineenumeration{#1}{4}{\v!sub\v!sub\v!sub}[#2][#3]\showdnsubsubsubnummer}

\def\defineenumeration%
  {\dotripleemptywithset\dodefineenumeration}

%  Het default-mechanisme kan mooier: leegtest, enz.
%
%  Werkprocedure buiten definitie

\def\dodosetupindentations[#1][#2]%
  {\getparameters[\??ds#1][#2]}

\def\dosetupindentations[#1][#2]%
  {\ConvertToConstant\doifelse{#2}{}
     {\dodosetupindentations[][#1]}
     {\dodoubleargumentwithset\dodosetupindentations[#1][#2]}}

\def\setupindentations
  {\dodoubleempty\dosetupindentations}

\def\startdoorspringen
  {\whitespace
   \@@dsbefore
   \dosomebreak{\goodbreak}% \page[\v!preference]
   \begingroup
   \parskip\zeropoint\relax}

\def\stopdoorspringen
  {\endgroup
   \@@dsafter}

\def\dododefineindenting#1#2#3%
  {\par
   \getvalue{\??ds#1\c!before}%
   \begingroup
   \doifvaluenothing{\??ds#1\c!sample}
     {\setvalue{\??ds#1\c!sample}%
        {\getvalue{\??ds#1\c!text}}}%
   \assignwidth
     {\!!widtha}
     {\getvalue{\??ds#1\c!width}}
     {\doattributes
        {\??ds#1}\c!headstyle\c!headcolor
        {\getvalue{\??ds#1\c!sample}\getvalue{\??ds#1\c!separator}}}
     {\getvalue{\??ds#1\c!distance}}%
   \advance\!!widtha \getvalue{\??ds#1\c!distance}%
   \setbox2\hbox to \!!widtha
     {\doattributes
        {\??ds#1}\c!headstyle\c!headcolor
        {\strut
         \getvalue{\??ds#1\c!text}%
         \hss
         \getvalue{\??ds#1\c!separator}%
         \hskip\getvalue{\??ds#1\c!distance}}}%
   \parindent\zeropoint
   \hskip#2\!!widtha\indent\box2%
   \hangindent#3\!!widtha
   \doattributes{\??ds#1}\c!style\c!color\empty
   \AfterPar% must be redone
     {\endgroup
      \getvalue{\??ds#1\c!after}}%
   \GetPar}

\def\dodefineindenting[#1][#2]%
  {\copyparameters[\??ds#1][\??ds]
      [\c!text,\c!separator,\c!width,\c!style,\c!color,
       \c!headstyle,\c!sample,\c!before,\c!after,\c!distance]%
   \getparameters[\??ds#1][#2]%
   \setvalue            {#1}{\dododefineindenting{#1}{0}{1}}%
   \setvalue      {\v!sub#1}{\dododefineindenting{#1}{1}{2}}%
   \setvalue{\v!sub\v!sub#1}{\dododefineindenting{#1}{2}{3}}}

\def\defineindenting%
  {\dodoubleargumentwithset\dodefineindenting}

% \def\dodoorlabel[#1][#2]%
%   {\getvalue{\s!number#1\c!voor}%
%    \bgroup
%    \doifvalue{\s!number#1\c!plaats}{\v!marge}
%      {\setvalue{\s!number#1\c!plaats}{\v!inmarge}}%
%    \doattributes{\s!number#1}\c!kopletter\c!kopkleur
%      {\getvalue{\e!volgende#1}[#2]}%
%    \egroup
%    \getvalue{\s!number#1\c!na}}%
%
% \def\dovolgendedoorlabel[#1][#2]%
%   {\nextnumber[#1][\s!lab][#2]}
%
% \def\dodoorlabelen[#1][#2]%
%   {\definenumber
%      [#1][\c!voor=,\c!na=,\c!kopletter=,\c!wijze=\@@nrwijze,#2]%
%    \setvalue           {#1}{\dodoubleempty\dodoorlabel[#1]}%
%    \setvalue{\s!reset   #1}{\resetnumber[#1]}%
%    \setvalue{\e!verhoog #1}{\incrementnumber[#1]}%
%    \setvalue{\e!volgende#1}{\dodoubleempty\dovolgendedoorlabel[#1]}%
%    \setvalue{\c!huidige #1}{\currentnumber[#1]}}
%
% \def\doorlabelen%
%   {\dodoubleargumentwithset\dodoorlabelen}

\def\dodoorlabel[#1][#2]%
  {\getvalue{\??lb#1\c!before}%
   \getvalue{\??lb#1\c!command}%
     {\doattributes{\??lb#1}\c!headstyle\c!headcolor
        {\dotextprefix{\getvalue{\??lb#1\c!text}}%
         \getvalue{\e!next#1}[#2]}}%
   \getvalue{\??lb#1\c!after}}%

\def\dovolgendedoorlabel[#1][#2]%
  {\nextnumber[#1][\s!lab][#2]}

\def\dodefinelabel[#1][#2]%
  {\getparameters
     [\??lb#1]
     [\c!way=\@@nrway,\c!command=,\c!location=,#2]%
   % downward compatible
   \processaction
     [\getvalue{\??lb#1\c!location}]
     [  \v!inmargin=>\setvalue{\??lb#1\c!command}{\inmargin},
       \v!inleft=>\setvalue{\??lb#1\c!command}{\inleft  },
      \v!inright=>\setvalue{\??lb#1\c!command}{\inright },
          \v!margin=>\setvalue{\??lb#1\c!command}{\inmargin}]%
   % inefficient, we need to redesign this command
   \definenumber
     [#1]
     [\c!way=\getvalue{\??lb#1\c!way}]%
   % generated commands
   \setvalue           {#1}{\dodoubleempty\dodoorlabel[#1]}%
   \setvalue{\s!reset   #1}{\resetnumber[#1]}%
   \setvalue{\e!increment #1}{\incrementnumber[#1]}%
   \setvalue{\e!next#1}{\dodoubleempty\dovolgendedoorlabel[#1]}%
   \setvalue{\c!current #1}{\currentnumber[#1]}}

\def\definelabel
  {\dodoubleargumentwithset\dodefinelabel}

\setupdescriptions
  [\c!location=\v!left,
   \c!headstyle=\v!bold,
   \c!style=\v!normal,
   \c!color=,
   \c!headcolor=,
   \c!width=8em,
   \c!distance=0pt,
   \c!hang=,
   \c!sample=,
   \c!align=,
   \c!margin=\v!no,
   \c!before=\blank,
   \c!inbetween=\blank,
   \c!after=\blank,
   \c!indentnext=\v!yes,
   \c!indenting=\v!never,
   \c!command=]

\setupenumerations
  [\c!location=\v!top,
   \c!headstyle=\v!bold,
   \c!headcolor=,
   \c!style=\v!normal,
   \c!color=,
   \c!width=8em,
   \c!distance=0pt,
   \c!hang=,
   \c!sample=,
   \c!align=,
   \c!margin=\v!no,
   \c!before=\blank,
   \c!inbetween=\blank,
   \c!after=\blank,
   \c!indentnext=\v!yes,
   \c!indenting=\v!never,
   \c!text=,
   \c!levels=3,                % to be upward compatible
   \c!conversion=,               % to be upward compatible
   \c!way=\v!by\v!text,
   \c!sectionnumber=\v!yes,
   \c!separator=.,
   \c!stopper=,
   \c!number=,
   \c!command=]

\setupindentations
  [\c!style=\v!normal,
   \c!headstyle=\v!normal,
   \c!color=,
   \c!headcolor=,
   \c!width=\v!fit,
   \c!text=\unknown,
   \c!sample=,
   \c!before=\blank,
   \c!after=\blank,
   \c!distance=1em,
   \c!separator={ :}]

\protect \endinput
