%D \module
%D   [       file=cont-new,
%D        version=1995.10.10,
%D          title=\CONTEXT\ Miscellaneous Macros,
%D       subtitle=New Macros,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA / Hans Hagen \& Ton Otten}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

% manual : offsetbox alignbox 

\unprotect

%D This file is loaded at runtime, thereby providing an
%D excellent place for hacks and new features.

\writestatus{\m!systems}{beware: some patches loaded from cont-new.tex!}

\def\checkframedtext%
  {\ifinsidefloat
     \localhsize\hsize
   \else\ifdim\sidefloatvsize>\zeropoint % will be proper handle 
   %  \strut            % rather clean way to invoke the sidefloat OTR
   %  \setbox0=\lastbox % and get the widths set, so from now on we
   %  \setlocalhsize    % can have framed texts alongside sidefloats
   \checksidefloat
   \setlocalhsize
     \advance\localhsize-\hangindent
   \else
     \localhsize\hsize
   \fi \fi}

\long\def\parseTR[#1][#2]#3\eTR% [#2] is dummy that kills spaces
  {\def\currentcol{0}\increment\maximumrow
   \setupTABLE[\v!rij][\maximumrow][#1]#3}

\def\obeyfollowingtoken{{}}  % end \cs scanning 

\def\gobbleparameters{\doquadrupleempty\dogobbleparameters}
\def\dogobbleparameters[#1][#2][#3][#4]{}

% faster, and looks okay

\dostepwiserecurse{0}{255}{1}
  {\@EA\chardef\csname-\recurselevel\endcsname=\recurselevel}

\newtoks\withminorcharacters
\newtoks\withlowercharacters
\newtoks\withuppercharacters

% \thewithcharacter#1 % self 

\dostepwiserecurse{0}{31}{1}
  {\expanded
     {\appendtoks\noexpand\withcharacter\csname-\recurselevel\endcsname
        \noexpand\to\withminorcharacters}}

\dostepwiserecurse{32}{127}{1}
  {\expanded
     {\appendtoks\noexpand\withcharacter\csname-\recurselevel\endcsname
        \noexpand\to\withlowercharacters}}

\dostepwiserecurse{128}{255}{1}
  {\expanded
     {\appendtoks\noexpand\withcharacter\csname-\recurselevel\endcsname
        \noexpand\to\withuppercharacters}}

\def\doassigncatcodes#1%
  {\def\withcharacter##1{\catcode##1#1}%
   \the\withminorcharacters
   \the\withlowercharacters
   \ifeightbitcharacters\the\withuppercharacters\fi}

\def\makeallother%
  {\doassigncatcodes\@@other}

\makeallothertoks\emptytoks
 
\chardef\obeyedlccode=`. % so <32 and >127 chars become . 

\def\obeylccodes%
  {\def\withcharacter##1{\lccode##1##1}%
   \the\withlowercharacters
   \def\withcharacter##1{\lccode##1\obeyedlccode}%
   \the\withminorcharacters
   \ifeightbitcharacters\the\withuppercharacters\fi}

\definesystemvariable{en}

\def\setupenv{\dodoubleargument\rawgetparameters[\??en]}

\def\doifenvelse#1{\doifdefinedelse{\??en#1}}

% \def\envvar#1#2{\ifundefined{\??en#1}#2\else\getvalue{\??en}\fi}

\def\env#1{\getvalue{\??en#1}}

\beginTEX

\def\envvar#1#2%
  {\@EA\ifx\csname\??en#1\endcsname\relax
     #2\else\csname\??en#1\endcsname
   \fi}

\endTEX

\beginETEX \ifcsname

\def\envvar#1#2%
  {\ifcsname\??en#1\endcsname
     \csname\??en#1\endcsname\else#2%
   \fi}

\endETEX

\def\setvariables%
  {\dodoubleargument\dosetvariables}

\def\dosetvariables[#1][#2]%
  {\def\currentvariableclass{#1}%
   \getparameters[vars:#1:][#2]}

\def\getvariable#1#2%
  {\ifundefined{vars:#1:#2}\else\getvalue{vars:#1:#2}\fi}

\let\currentvariableclass\empty

% in both (otr) modules ! 

\def\doifrightpageelse#1#2%
  {\ifdubbelzijdig
     \gettwopassdata{\s!paragraph}%
     \iftwopassdatafound
       \ifodd\twopassdata#1\else#2\fi
     \else
       \ifodd\realfolio#1\else#2\fi
     \fi
   \else
     #1% was #2 
   \fi}

\def\signalrightpage%
  {\ifdubbelzijdig
     \doparagraphreference
   \fi}

%D To be documented, \type {\includemenu[menu]}. 
%D To be documented, \type {\emphbf} cum suis.

%D A prelude to strategies. Note for myself: overloads
%D previous stuff from local pragma test files.

\def\s!strategy{strategy}

\def\currentstrategypass    {1}
\def\currentstrategyvariable{0}
\def\maximumstrategypass    {8}

\newconditional\strategypassneeded
\newconditional\strategypassforced

\definetwopasslist{\s!strategy}

\def\registerstrategypass%
  {\ifnum\currentstrategypass>\maximumstrategypass \else
     \ifconditional\strategypassforced
       \doglobal\increment\currentstrategypass
     \else%\ifconditional\strategypassneeded
       %\doglobal\increment\currentstrategypass
     \fi%\fi
   \fi
   \savecurrentvalue\currentstrategypass{\currentstrategypass}}

\appendtoks \registerstrategypass \to \everybye % \everylastshipout

\def\setstrategyvariable#1#2% key value
  {%\doifnotstrategyvariable{#1}{\global\settrue\strategypassneeded}%
   \doglobal\increment\currentstrategyvariable
   \expanded{\immediatewriteutilitycommand{\noexpand
     \twopassentry{\s!strategy}{\currentstrategyvariable}{#1::#2}}}}

\def\doifstrategyvariableelse#1#2#3%
  {\getstrategyvariable{#1}\iftwopassdatafound#2\else#3\fi}

\def\getstrategyvariable#1% key
  {\findtwopassdata{\s!strategy}{#1::}%
   \setxvalue{\s!strategy:#1}{\twopassdata}}

\def\retainstrategyvariable#1% key
  {\expanded{\setstrategyvariable{#1}{\strategyvariable{#1}}}}

\def\strategyvariable#1% key
  {\csname\s!strategy:#1\endcsname}

\let\stratvar\strategyvariable

\def\forcestrategy{\global\settrue \strategypassforced}
\def\abortstrategy{\global\setfalse\strategypassforced}

\def\doifstrategyvariableelse#1#2#3%
  {\getstrategyvariable{#1}\iftwopassdatafound#2\else#3\fi}

\def\doifstrategyvariable   #1#2{\doifstrategyvariableelse{#1}{#2}{}}
\def\doifnotstrategyvariable#1#2{\doifstrategyvariableelse{#1}{}{#2}}

%D New: only at start of columns; may change ! Rather 
%D interwoven and therefore to be integrated when the multi 
%D column modules are merged. 

%  already taken care of: \definesystemvariable{ks}

\def\setupcolumnspan[#1]%
  {\getparameters[\??ks][#1]}

\presetlocalframed
  [\??ks]

\setupcolumnspan
  [\c!n=2,
   \c!offset=\v!overlay,
   \c!kader=\v!uit]

\newbox\columnspanbox \let\postprocesscolumnspanbox\gobbleoneargument

\def\dostartcolumnspan[#1]%
  {\bgroup
   \setupcolumnspan[#1]%
   \forgetall
   \ifbinnenkolommen
     \advance\hsize by \intercolumnwidth
     \hsize=\@@ksn\hsize
     \advance\hsize by -\intercolumnwidth
   \fi
   \dowithnextbox
     {\setbox\columnspanbox=\box\nextbox
      \ifbinnenkolommen\wd\columnspanbox=\hsize\fi
      \postprocesscolumnspanbox\columnspanbox
      \scratchdimen=\ht\columnspanbox
      \setbox\columnspanbox=\hbox % depth to be checked, probably option!
        {\localframed[\??ks][\c!offset=\v!overlay]{\box\columnspanbox}}%
      \ht\columnspanbox=\scratchdimen
      \dp\columnspanbox=\dp\strutbox
      \wd\columnspanbox=\hsize
      \ifbinnenkolommen
        \ifnum\@@ksn>1
          \setvsize
          \dohandleallcolumns
            {\ifnum\currentcolumn>\@@ksn\else
               \global\setbox\currenttopcolumnbox=\vbox
                 {\ifnum\currentcolumn=1
                    \snaptogrid\vbox{\copy\columnspanbox}
                  \else
                    \snaptogrid\vbox{\vphantom{\copy\columnspanbox}}
                  \fi}%
               \wd\currenttopcolumnbox=\hsize
               \global\advance\vsize by -\ht\currenttopcolumnbox
             \fi}
          \global\pagegoal=\vsize
        \else
          \snaptogrid\vbox{\box\columnspanbox}
        \fi
      \else
        \snaptogrid\vbox{\box\columnspanbox}
      \fi
      \prevdepth\dp\strutbox
      \egroup}
     \vbox\bgroup
      %\topskipcorrection % becomes an option ! 
       \EveryPar{\begstrut\EveryPar{}}} % also ! 

\def\startcolumnspan%
  {\dosingleempty\dostartcolumnspan}

\def\stopcolumnspan%
  {\egroup}

%D For Ton. Do be documented.

\def\plaatsexterndocument[#1]%
  {\def\doexternaldocument[##1][##2][##3]%
     {\readlocfile{##2}{}{}}%
   \getvalue{\v!file:::#1}}

%D Far from complete. 

\def\startgeheel%
  {\startregelcorrectie
   \insidefloattrue}

\def\stopgeheel
  {\stopregelcorrectie}

%D No more news. 

\protect

%D A few local optimizations and new features, if defined: 

\readfile {cont-loc} {} {}

\endinput
