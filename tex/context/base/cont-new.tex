%D \module
%D   [       file=cont-new,
%D        version=1995.10.10,
%D          title=\CONTEXT\ Miscellaneous Macros,
%D       subtitle=New Macros,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA / Hans Hagen \& Ton Otten}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

% manual : offsetbox alignbox 

\def\placefloats{\doflushfloats}  % keep this one 

\unprotect

\def\definieertekst%
  {\doseventupleempty\dodefinieertekst}

\def\dodefinieertekst[#1][#2][#3][#4][#5][#6][#7]%
  {\ifseventhargument
     \setvalue{\??tk#2#3#1}{\dosixtupleempty\dodododoteksten[#2][#3][#4][#5][#6][#7]}%
   \else\ifsixthargument
     \setvalue{\??tk  #2#1}{\dosixtupleempty\dodododoteksten[#2][#3][#4][#5][#6]}%
   \else\iffifthargument
     \setvalue{\??tk#2#3#1}{\dosixtupleempty\dodododoteksten[#2][#3][#4][#5]}%
   \else\iffourthargument
     \setvalue{\??tk  #2#1}{\dosixtupleempty\dodododoteksten[#2][#3][#4]}%
   \else
     \setvalue{\??tk  #2#1}{\dosixtupleempty\dodododoteksten[#2][#3]}%
   \fi\fi\fi\fi}

\def\plaatslayoutregel#1#2%  % handelt o.b.v. tekst
  {%\message{#1: \getvalue{\??tk#1\v!tekst\c!status}}\wait
   \ExpandFirstAfter\processaction
     [\getvalue{\??tk#1\v!tekst\c!status}]
     [        \v!geen=>,
              \v!hoog=>, % is reset later on
             \v!start=>\setgvalue{\??tk#1\v!tekst\c!status}{\v!normaal}%
                       \doplaatslayoutregel{#1}{#2},
              \v!stop=>\vskip#2\relax,
              \v!leeg=>\setgvalue{\??tk#1\v!tekst\c!status}{\v!normaal}%
                       \vskip#2\relax,
     \v!geenmarkering=>\bgroup
                       \setgvalue{\??tk#1\v!tekst\c!status}{\v!normaal}%
                       \let\dohaalmarkering=\nohaalmarkering
                       \doplaatslayoutregel{#1}{#2}%
                       \egroup,
           \v!normaal=>\doplaatslayoutregel{#1}{#2},
           \s!default=>\doplaatslayoutregel{#1}{#2},
           \s!unknown=>\bgroup % new
                       \setgvalue{\??tk#1\v!tekst\c!status}{\v!normaal}%
%                      \getvalue{\??tk#1\commalistelement}%
\setlocallayoutline{#1\commalistelement}%
\setlocallayoutline{#1\v!tekst\commalistelement}%
\setlocallayoutline{#1\v!marge\commalistelement}%
\setlocallayoutline{#1\v!rand\commalistelement}%
                       \doplaatslayoutregel{#1}{#2}%
                       \egroup]}

\def\setlocallayoutline#1%
  {\ifundefined{\??tk#1}\else\getvalue{\??tk#1}\fi}

% permits \stoptext inside module 

\def\dousemodules[#1]%
  {\doifelsenothing{#1}
     {\let\next\relax}
     {\def\next{\processcommalist[#1]\dodousemodules}}
   \next}

\def\dododousemodules#1#2% we need to protect \next somehow 
  {\relax
   \ifconditional\moduleisloaded
     \let\next\relax
   \else
     \makeshortfilename[#1\truefilename{#2}]%
     \doifundefinedelse{\shortfilename\v!aan}
       {\setgvalue{\shortfilename\v!aan}{}%
        \def\next
          {\startreadingfile
           \readsysfile{\shortfilename}%
             {\showmessage{\m!systems}{5}{#2}%
              \settrue\moduleisloaded}%
             {}%
           \stopreadingfile}}
       {\showmessage{\m!systems}{7}{#2}%
        \settrue\moduleisloaded
        \let\next\relax}%
   \fi
   \next}

%D This file is loaded at runtime, thereby providing an
%D excellent place for hacks and new features.

\writestatus{\m!systems}{beware: some patches loaded from cont-new.tex!}

\definesystemvariable{en}

\def\setupenv{\dodoubleargument\rawgetparameters[\??en]}

\def\doifenvelse#1{\doifdefinedelse{\??en#1}}

\def\env#1{\getvalue{\??en#1}} % geen (!) test hier 

\def\inputfilename{\@@svinputfile} 

\setupsystem[inputfile=\outputfilename] % yes or no 

% already patched 

\def\setdisplaydimensions%
  {\displayindent=\leftdisplayskip 
   \advance\displayindent\leftdisplaymargin 
   \displaywidth=\hsize
   \ifdim\hangindent>\!!zeropoint
     \advance\displayindent\hangindent
   \else
     \advance\displaywidth\hangindent
   \fi
   \advance\displaywidth-\displayindent
   \advance\displaywidth-\rightdisplayskip
   \advance\displaywidth-\rightdisplaymargin}

% already patched 

\def\dochecksidefloat%
  {\progresssidefloat
   \ifdim\!!heighta>\!!zeropoint
%     \advance\!!heighta by \sidefloatbottomskip
%     \!!counta=\!!heighta
\scratchdimen=\!!heighta
\advance\scratchdimen \ht\strutbox
\!!counta=\scratchdimen
     \divide\!!counta by \baselineskip
     \ifnum\!!counta>0
       \ifrightfloat
         \hangindent=-\sidefloatwidth
       \else
         \hangindent=\sidefloatwidth
       \fi
       \hangafter=-\!!counta
     \fi
     \setsidefloatparagraph
   \else
     \resetsidefloatparagraph
   \fi
   \parskip=\tussenwit}


\def\setsidefloat%
  {\vbox{\strut}\vskip-\lineheight
   \kern\sidefloattopskip
   \edef\presidefloatdepth{\the\prevdepth}%
   \nointerlineskip
   \bgroup
   \everypar={}%
   \parskip=\!!zeropoint
   \logsidefloat
   \ifrightfloat
     \hfill
     \ifmarginfloat
       \rlap{\hskip\rechtermargeafstand\hskip\rightskip\unhbox\floatbox}%
     \else
       \unhbox\floatbox
     \fi
   \else
     \noindent
     \ifmarginfloat
       \llap{\unhbox\floatbox\hskip\leftskip\hskip\linkermargeafstand}%
     \else
       \unhbox\floatbox
     \fi
     \hfill
   \fi
   \egroup
   \par
   \kern-\sidefloatheight
   \penalty10001
   \normalbaselines
   \prevdepth=\presidefloatdepth
   %\noindent
   \resetsidefloatparagraph
   \ignorespaces}

% already patched 

\def\doapplyfiguresize%
  {\doifelsenothing{\@@efmaxhoogte}
     {\figurevsize=\teksthoogte
      \ifinner
        \figurevsize =\vsize % \teksthoogte =\vsize
        \scratchdimen=\vsize % \scratchdimen=\teksthoogte
      \else\ifinsidefloat
        \figurevsize =\vsize % \teksthoogte =\vsize
        \scratchdimen=\vsize % \scratchdimen=\teksthoogte
      \else\ifinpagebody
        \figurevsize =\vsize % \teksthoogte =\vsize
        \scratchdimen=\vsize % \scratchdimen=\teksthoogte
      \else
        \ifdim\pagegoal<\maxdimen
          \ifdim\pagetotal<\pagegoal
            \scratchdimen=\pagegoal
            \advance\scratchdimen by -\pagetotal
          \else
            \scratchdimen=\figurevsize % \teksthoogte
          \fi
        \else
          \scratchdimen=\figurevsize % \teksthoogte
        \fi
      \fi\fi\fi}
     {\figurevsize=\@@efmaxhoogte}%
   \doifelsenothing{\@@efhoogte}
     {\edef\@@efvsize{\the\scratchdimen}}
     {\let\@@efvsize=\@@efhoogte}%
   \doifelsenothing{\@@efbreedte}
     {\edef\@@efhsize{\the\hsize}}
     {\let\@@efhsize=\@@efbreedte}}

\def\setvariables%
  {\dodoubleargument\dosetvariables}

\def\dosetvariables[#1][#2]%
  {\def\currentvariableclass{#1}%
   \getparameters[vars:#1:][#2]}

\def\getvariable#1#2%
  {\ifundefined{vars:#1:#2}\else\getvalue{vars:#1:#2}\fi}

\let\currentvariableclass\empty

% in both (otr) modules ! 

\def\doifrightpageelse#1#2%
  {\ifdubbelzijdig
     \gettwopassdata{\s!paragraph}%
     \iftwopassdatafound
       \ifodd\twopassdata#1\else#2\fi
     \else
       \ifodd\realfolio#1\else#2\fi
     \fi
   \else
     #1% was #2 
   \fi}

\def\signalrightpage%
  {\ifdubbelzijdig
     \doparagraphreference
   \fi}

%D To be documented, \type {\includemenu[menu]}. 
%D To be documented, \type {\emphbf} cum suis.

%D A prelude to strategies. Note for myself: overloads
%D previous stuff from local pragma test files.

\def\s!strategy{strategy}

\def\currentstrategypass    {1}
\def\currentstrategyvariable{0}
\def\maximumstrategypass    {8}

\newconditional\strategypassneeded
\newconditional\strategypassforced

\definetwopasslist{\s!strategy}

\def\registerstrategypass%
  {\ifnum\currentstrategypass>\maximumstrategypass \else
     \ifconditional\strategypassforced
       \doglobal\increment\currentstrategypass
     \else%\ifconditional\strategypassneeded
       %\doglobal\increment\currentstrategypass
     \fi%\fi
   \fi
   \savecurrentvalue\currentstrategypass{\currentstrategypass}}

\appendtoks \registerstrategypass \to \everybye % \everylastshipout

\def\setstrategyvariable#1#2% key value
  {%\doifnotstrategyvariable{#1}{\global\settrue\strategypassneeded}%
   \doglobal\increment\currentstrategyvariable
   \expanded{\immediatewriteutilitycommand{\noexpand
     \twopassentry{\s!strategy}{\currentstrategyvariable}{#1::#2}}}}

\def\doifstrategyvariableelse#1#2#3%
  {\getstrategyvariable{#1}\iftwopassdatafound#2\else#3\fi}

\def\getstrategyvariable#1% key
  {\findtwopassdata{\s!strategy}{#1::}%
   \setxvalue{\s!strategy:#1}{\twopassdata}}

\def\retainstrategyvariable#1% key
  {\expanded{\setstrategyvariable{#1}{\strategyvariable{#1}}}}

\def\strategyvariable#1% key
  {\csname\s!strategy:#1\endcsname}

\let\stratvar\strategyvariable

\def\forcestrategy{\global\settrue \strategypassforced}
\def\abortstrategy{\global\setfalse\strategypassforced}

\def\doifstrategyvariableelse#1#2#3%
  {\getstrategyvariable{#1}\iftwopassdatafound#2\else#3\fi}

\def\doifstrategyvariable   #1#2{\doifstrategyvariableelse{#1}{#2}{}}
\def\doifnotstrategyvariable#1#2{\doifstrategyvariableelse{#1}{}{#2}}

%D New: only at start of columns; may change ! Rather 
%D interwoven and therefore to be integrated when the multi 
%D column modules are merged. 

%  already taken care of: \definesystemvariable{ks}

\def\setupcolumnspan[#1]%
  {\getparameters[\??ks][#1]}

\presetlocalframed
  [\??ks]

\setupcolumnspan
  [\c!n=2,
   \c!offset=\v!overlay,
   \c!kader=\v!uit]

\newbox\columnspanbox \let\postprocesscolumnspanbox\gobbleoneargument

\def\dostartcolumnspan[#1]%
  {\bgroup
   \setupcolumnspan[#1]%
   \forgetall
   \ifbinnenkolommen
     \advance\hsize by \intercolumnwidth
     \hsize=\@@ksn\hsize
     \advance\hsize by -\intercolumnwidth
   \fi
   \dowithnextbox
     {\setbox\columnspanbox=\box\nextbox
      \ifbinnenkolommen\wd\columnspanbox=\hsize\fi
      \postprocesscolumnspanbox\columnspanbox
      \scratchdimen=\ht\columnspanbox
      \setbox\columnspanbox=\hbox % depth to be checked, probably option!
        {\localframed[\??ks][\c!offset=\v!overlay]{\box\columnspanbox}}%
      \ht\columnspanbox=\scratchdimen
      \dp\columnspanbox=\dp\strutbox
      \wd\columnspanbox=\hsize
      \ifbinnenkolommen
        \ifnum\@@ksn>1
          \setvsize
          \dohandleallcolumns
            {\ifnum\currentcolumn>\@@ksn\else
               \global\setbox\currenttopcolumnbox=\vbox
                 {\ifnum\currentcolumn=1
                    \snaptogrid\vbox{\copy\columnspanbox}
                  \else
                    \snaptogrid\vbox{\vphantom{\copy\columnspanbox}}
                  \fi}%
               \wd\currenttopcolumnbox=\hsize
               \global\advance\vsize by -\ht\currenttopcolumnbox
             \fi}
          \global\pagegoal=\vsize
        \else
          \snaptogrid\vbox{\box\columnspanbox}
        \fi
      \else
        \snaptogrid\vbox{\box\columnspanbox}
      \fi
      \prevdepth\dp\strutbox
      \egroup}
     \vbox\bgroup
      %\topskipcorrection % becomes an option ! 
       \EveryPar{\begstrut\EveryPar{}}} % also ! 

\def\startcolumnspan%
  {\dosingleempty\dostartcolumnspan}

\def\stopcolumnspan%
  {\egroup}

%D For Ton. Do be documented.

\def\plaatsexterndocument[#1]%
  {\def\doexternaldocument[##1][##2][##3]%
     {\readlocfile{##2}{}{}}%
   \getvalue{\v!file:::#1}}

%D Far from complete. 

\def\startgeheel%
  {\startregelcorrectie
   \insidefloattrue}

\def\stopgeheel
  {\stopregelcorrectie}

%D No more news. 

\protect

%D A few local optimizations and new features, if defined: 

\readfile {cont-loc} {} {}

\endinput
