%D \module
%D   [       file=meta-ini,
%D        version=1999.07.10,
%D          title=\METAPOST\ Graphics, 
%D       subtitle=Initialization, 
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA / Hans Hagen \& Ton Otten}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for 
%C details. 

%D These definitions used to be part of the old \type
%D {core-mps} file, later changed into \type {meta-ini}, but
%D keeping them separate is cleaner. 

\writestatus{loading}{MetaPost Graphics / Page Data Management}

\unprotect 

\appendtoks 
  if unknown context_page : input mp-page ; fi ; 
\to \MPinitializations 

%D The next few macros tell \METAPOST\ how the \CONTEXT\ 
%D pagebody looks. 

\startuseMPgraphic{page data}
  boolean PageStateAvailable ; PageStateAvailable := true ; 
  boolean OnRightPage        ; OnRightPage        := true ;  
  def LoadPageState = 
    OnRightPage         :=     \MPonrightpage ; 
    PageNumber          :=     \realfolio ; 
    PaperHeight         := \the\papierhoogte ;
    PaperWidth          := \the\papierbreedte ;
    PrintPaperHeight    := \the\printpapierhoogte ;
    PrintPaperWidth     := \the\printpapierbreedte ;
    TopSpace            := \the\kopwit ;
    BackSpace           := \the\rugwit ;
    MakeupHeight        := \the\zethoogte ;
    MakeupWidth         := \the\zetbreedte ;
    TopHeight           := \the\bovenhoogte ;
    TopDistance         :=     \bovenafstand ;
    HeaderHeight        := \the\hoofdhoogte ;
    HeaderDistance      :=     \hoofdafstand ;
    TextHeight          := \the\teksthoogte ;
    FooterDistance      :=     \voetafstand ;
    FooterHeight        := \the\voethoogte ;
    BottomDistance      :=     \onderafstand ;
    BottomHeight        := \the\onderhoogte ;
    LeftEdgeWidth       := \the\linkerrandbreedte ;
    LeftEdgeDistance    :=     \linkerrandafstand ;
    LeftMarginWidth     := \the\linkermargebreedte ;
    LeftMarginDistance  :=     \linkermargeafstand ;
    TextWidth           := \the\tekstbreedte ;
    RightMarginDistance :=     \rechtermargeafstand ;
    RightMarginWidth    := \the\rechtermargebreedte ;
    RightEdgeDistance   :=     \rechterrandafstand ;
    RightEdgeWidth      := \the\rechterrandbreedte ;
    PageOffset          :=     \MPpageoffset ;
    PageDepth           :=     \MPpagedepth ;
  enddef ; 
\stopuseMPgraphic
              
\def\MPonrightpage{true} 
\let\MPpageoffset \!!zeropoint
\let\MPpagedepth  \!!zeropoint

\def\freezeMPpagelayout%
  {\doifelsevalue{\??ma\v!pagina\c!offset}{\v!overlay}
     {\let\MPpageoffset\!!zeropoint}
     {\edef\MPpageoffset{\getvalue{\??ma\v!pagina\c!offset}}}%
   \edef\MPpagedepth{\getvalue{\??ma\v!pagina\c!diepte}}%
   \freezedimenmacro\MPpageoffset
   \freezedimenmacro\MPpagedepth
   \doifbothsides 
     \def\MPonrightpage{true}% 
   \orsideone
     \def\MPonrightpage{true}% 
   \orsidetwo
     \def\MPonrightpage{false}% 
   \od}
 
\def\freezeMPlayout% must be done more efficient
  {\freezedimenmacro\bovenafstand         
   \freezedimenmacro\hoofdafstand         
   \freezedimenmacro\voetafstand          
   \freezedimenmacro\onderafstand         
   \freezedimenmacro\linkerrandafstand    
   \freezedimenmacro\linkermargeafstand   
   \freezedimenmacro\rechtermargeafstand  
   \freezedimenmacro\rechterrandafstand}   

%D We need to freeze the pagelayout before the backgrounds 
%D are build, because the overlay will temporarily become 
%D zero (overlay).

\appendtoks 
  \freezeMPpagelayout 
\to \everypagebody 

%D By freezing these value every graphic, we can use layout 
%D variables that change halfways a page, whatever use that 
%D has. 

\prependtoks 
  \calculatereducedvsizes % this is really needed
  \freezeMPlayout % to be used grouped 
\to \everyMPgraphic 

\appendtoks 
  \includeMPgraphic{page data} 
\to \MPinitializations

\protect \endinput 
