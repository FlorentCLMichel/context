%D \module
%D   [       file=supp-ran,
%D        version=1998.01.21,
%D          title=\CONTEXT\ Support Macros,
%D       subtitle=Random Number Generation,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA / Hans Hagen \& Ton Otten}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for 
%C details. 

\writestatus{loading}{Third Party Macros / Random Number Generation}

%D \macros
%D   {getrandomcount, getrandomdimen, 
%D    getrandomfloat, getrandomnumber,
%D    setrandomseed, getrandomseed}
%D 
%D This module load Donald Arseneau's generic file
%D \type{random.tex}. A small shell is needed because we
%D redefine some \TEX\ primitives. We also use different names 
%D for the two generators and add an extra one.
%D 
%D \starttypen
%D \getrandomcount  \countregister {minimum} {maximum}
%D \getrandomdimen  \dimenregister {minimum} {maximum}
%D \getrandomnumber \macroname     {minimum} {maximum}
%D \getrandomfloat  \macroname     {minimum} {maximum}
%D \stoptypen 
%D
%D Of course the file \type{random.tex} needs to be present.
%D To prevent name clashes, the \CONTEXT\ distribution 
%D contains a copy in \type {thrd-ran.tex}.
%D
%D The randomseed can be set by: 
%D
%D \starttypen
%d \setrandomseed{number>0}
%D \stoptypen
%D
%D and get by: 
%D
%D \starttypen
%D \getrandomseed\randomseed
%D \stoptypen

\ifx\nextrandom\undefined

  \readfile{random.tex}
    {\writestatus{loading}{Donald Arseneau's 'random.tex'     (found)}}
    {\writestatus{loading}{Donald Arseneau's 'random.tex' (not found)}}

\fi

\ifx\nextrandom\undefined

  \def\setrannum#1#2#3{#1=1  }
  \def\setrandim#1#2#3{#1=1pt}

\else

  \let\verynormalnextrandom = \nextrandom

  \def\normalnextrandom
    {\bgroup
     \let\time \normaltime   
     \let\day  \normalday
     \let\month\normalmonth  
     \let\year \normalyear
     \verynormalnextrandom
     \egroup}

  \chardef\randomseedfrozen=0

  \def\nextrandom
    {\bgroup
     \normalnextrandom
     \gdef\nextrandom
       {\ifcase\randomseedfrozen\normalnextrandom\fi}%
     \egroup}

  % avoid scratch dimens 0 and 2 

  \unprotect 

  \def\setrandim#1#2#3% dimen register, minimum length, maximum length
    {\scratchdimen#2\edef\!!stringa{\number\scratchdimen}%
     \scratchdimen#3\edef\!!stringb{\number\scratchdimen}%
     \setrannum\ranval\!!stringa\!!stringb
     #1\ranval sp\relax}

  \protect 

\fi

\def\freezerandomseed
  {\ifcase\randomseedfrozen
     \nextrandom \global\chardef\randomseedfrozen\plusone
   \fi}

\def\defrostrandomseed
  {\ifcase\randomseedfrozen\else
     \global\chardef\randomseedfrozen\zerocount \nextrandom
   \fi}

\let\getrandomcount = \setrannum
\let\getrandomdimen = \setrandim

\def\getrandomnumber#1#2#3%
  {\getrandomcount{\scratchcounter}{#2}{#3}%
   \edef#1{\the\scratchcounter}}

\def\getrandomfloat#1#2#3%
  {\getrandomdimen{\scratchdimen}{#2pt}{#3pt}%
   \edef#1{\withoutpt\the\scratchdimen}}

\unexpanded \def\setrandomseed#1%
  {\randomi=#1\relax}

\unexpanded \def\getrandomseed#1%
  {\edef#1{\number\randomi}}

\endinput
