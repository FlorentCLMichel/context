%D \module
%D   [      file=x-fig-00,
%D        version=2001.03.21,
%D          title=\CONTEXT\ Style File,
%D       subtitle=Figure Base Loading,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA / Hans Hagen \& Ton Otten}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for 
%C details. 

%D This module implements an interface to a figure database
%D and file. The database is formatted in \XML\ conforming 
%D the following \DTD: 
%D
%D \typefile{x-fig-00.dtd}
%D
%D A figure base coded this way looks like: 
%D 
%D \starttypen
%D <!-- texexec --pdf --use=fig-01 figtest.xml --> 
%D 
%D <figurelibrary language="nl"> 
%D 
%D   <description>
%D     <organization>PRAGMA Advanced Document Engineering</organization>
%D     <project>Manuals</project>
%D     <product>Beginners Manual</product>
%D     <comment>A bunch of figures.</comment>
%D   </description>
%D 
%D   <figure>
%D     <file>koe.pdf</file>
%D     <label>a dutch cow</label>
%D     <copyright>Corel Draw Suite</copyright>
%D     <comment>I bet that you've seen this cow before.</comment>
%D   </figure>
%D 
%D </figurelibrary> 
%D \stoptypen 
%D 
%D You can convert this base into a \PDF\ file using 
%D \TEXEXEC\ and another module in this suite. 
%D 
%D \starttypen 
%D texexec --pdf --use=fig-01 yourfile.xml
%D \stoptypen 
%D 
%D You can now select a graphic from this file using the 
%D 
%D \starttypen 
%D \externalfigure[a dutch cow][width=4cm]
%D \stoptypen 
%D
%D This module overloads this command so that it first 
%D searched in the list of databases. 
%D 
%D \starttypen 
%D \usefigurebases[yourfile]
%D \stoptypen 
%D 
%D The special keyword \type {reset} can be used to reset 
%D this list.

\startcommands      dutch                            english
                    german                           czech
                    italian                          romanian

     usefigurebase: gebruikfiguurbestand             usefigurebase 
                    usefigurebase                    usefigurebase 
                    usefigurebase                    usefigurebase 

\stopcommands 

\unprotect 

\startXMLnamespace [-] [figbase]

\defineXMLprocess     [figurelibrary]
\defineXMLignore      [description]
\defineXMLignore      [copyright]
\defineXMLignore      [comment]
\defineXMLignore      [status]
\defineXMLpush        [file]
\defineXMLpush        [label]
\defineXMLenvironment [figure] \figbase@StartFigure \figbase@StopFigure

\stopXMLnamespace

\def\figbase@StartFigure%
  {\bgroup}

\def\figbase@StopFigure%
  {\doglobal\increment\figurefilepage
   \doif{\askedlabel}{\XMLpop{label}}
     {\xdef\figurefilename{\XMLpop{file}}\endinput}%
   \egroup}

\def\getfigurefilename#1#2%
  {\startnointerference
     \startXMLnamespace[-][figbase]
       \resetfigurefilebase
       \XMLassign{file} {}
       \XMLassign{label}{}
       \xdef\figurefilebase{#1}%
       \doglobal\newcounter\figurefilepage
       \def\askedlabel{#2}
       \processXMLfile{#1.xml}
     \stopXMLnamespace
   \stopnointerference}

\def\resetfigurefilebase%
  {\global\let\figurefilebase\empty
   \global\let\figurefilename\empty
   \global\let\figurefilepage\empty}

\let\normalcalculateexternalfigure\calculateexternalfigure

\def\calculateexternalfigure[#1][#2][#3][#4][#5][#6]%
  {\resetfigurefilebase
   \ifx\figurebaselist\empty 
     \normalcalculateexternalfigure
       [#1][#2][#3][#4][#5][#6]%
   \else
     \def\docommando##1%
       {\getfigurefilename{##1}{#3}%
        \ifx\figurefilename\empty\else\quitcommalist\fi}%
     \processcommacommand[\figurebaselist]\docommando
     \ifx\figurefilename\empty
       \stripspaces\from#3\to\figurefilename % to be sure 
       \normalcalculateexternalfigure
         [#1][#2][\figurefilename][#4][#5][#6]%
     \else
        \normalcalculateexternalfigure
          [#1][#2][\figurefilebase.pdf][\c!pagina=\figurefilepage,#4][#5][#6]%
     \fi
   \fi}

\let\figurebaselist\empty

\def\usefigurebase[#1]%
  {\doifelse{#1}{\v!reset}
     {\let\figurebaselist\empty}
     {\appendcommacommand{#1}\figurebaselist}}

\endinput 

\usefigurebase[figtest]

\externalfigure[koetje]             [width=3cm]
\externalfigure[de molen op de dijk][width=3cm]
\externalfigure[de molen op de dijk][width=2cm]
\externalfigure[weet ik veel]       [width=3cm]
\externalfigure[weet ik veel]       [width=2cm]
\externalfigure[weet ik wat]        [width=2cm]
\externalfigure[koe]                [width=2cm]
