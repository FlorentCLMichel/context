%D \module
%D   [       file=meta-fig,
%D        version=2000.09.07,
%D          title=\METAPOST\ Graphics,
%D       subtitle=Stand Alone Graphics,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA / Hans Hagen \& Ton Otten}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\writestatus{loading}{MetaPost Graphics / Stand Alone Graphics}

\unprotect

%D This module implements a method for defining
%D stand||alone||graphics, that is, each graphic gets is own
%D page. Because graphics are wrapped in a \type {\framed},
%D you can add overlays to the graphic directly, and since the
%D whole \CONTEXT\ machinery is available, you can also add
%D page backgrounds.
%D
%D \starttypen
%D \setupMPpage
%D   [offset=1pt,
%D    background=color,
%D    backgroundcolor=green]
%D
%D \startMPpage
%D   fill fullcircle scaled 10cm withcolor red ;
%D \stopMPpage
%D
%D \startMPpage
%D   fill fullsquare rotated 45 scaled 8cm withcolor blue ;
%D \stopMPpage
%D \stoptypen
%D
%D Although this is hardly of any use, you can mix these
%D definitions with the text flow, since all settings are
%D kept local. The page is clipped to the image size.

% generalized, so this belongs in another module 

\def\dostartfittingpage[#1][#2]%
  {\pagina
   \bgroup
   \setbox\scratchbox=\hbox
     \bgroup
     \getparameters[#1][#2]%
     \schaal[\c!schaal=\getvalue{#1\c!schaal}]\bgroup\localframed[#1]\bgroup}

\def\dostopfittingpage%
  {\egroup\egroup\egroup
   \edef\fittingwd{\the\wd\scratchbox}%
   \edef\fittinght{\the\ht\scratchbox}%
   \definepapersize
     [\s!dummy]
     [\c!breedte=\fittingwd,
      \c!hoogte=\fittinght]%
   \startlocal % keep settings as local as can be
     \setuppapersize
       [\s!dummy][\s!dummy]%
     \stellayoutin
       [\c!breedte=\fittingwd,\c!hoogte=\fittinght,\c!plaats=\v!midden,
        \c!kopwit=\!!zeropoint,\c!rugwit=\!!zeropoint,
        \c!snijwit=\!!zeropoint,\c!bodemwit=\!!zeropoint,
        \c!hoofd=\!!zeropoint,\c!voet=\!!zeropoint]%
   \stoplocal % which saves us the trouble of push/pop
   \startmakeup[\v!standaard][\c!tekststatus=\v!leeg,\c!dubbelzijdig=\v!nee,\c!pagina=]%
     \centerbox{\box\scratchbox}%
   \stopmakeup
   \egroup}

% MP pages 

\presetlocalframed[\??mg]

\def\setupMPpage%
  {\dodoubleargument\getparameters[\??mg]}

\def\startMPpage%
  {\dosingleempty\dostartMPpage}

\long\def\dostartMPpage[#1]#2\stopMPpage
  {\dostartfittingpage[\??mg][#1]%
     \startMPcode#2\stopMPcode
   \dostopfittingpage}

\setupMPpage
  [\c!schaal=1000,
   \c!strut=\v!nee,
   \c!uitlijnen=,
   \c!offset=\v!overlay,
   \c!breedte=\v!passend,
   \c!hoogte=\v!passend,
   \c!kader=\v!uit]

% tex pages 

\presetlocalframed[\??tg]

\def\setupTEXpage%
  {\dodoubleargument\getparameters[\??tg]}

\def\startTEXpage%
  {\dodoubleempty\dostartfittingpage[\??tg]}

\def\stopTEXpage%
  {\dostopfittingpage}

\setupTEXpage
  [\c!schaal=1000,
   \c!strut=\v!nee,
   \c!uitlijnen=\v!normaal, % needed, else problems !
   \c!offset=\v!overlay,
   \c!breedte=\v!passend,
   \c!hoogte=\v!passend,
   \c!kader=\v!uit]

%D \macros 
%D  {MPfigure}
%D
%D A bit out of place, here but nevertheless: 

\def\MPfigure#1#2% test for dup figure
  {\bgroup
   \getfiguredimensionsonly[#1]% [\c!object=\v!nee] already set 
   \freezedimenmacro\naturalfigurewidth
   \freezedimenmacro\naturalfigureheight
   \startMPcode
     externalfigure "#1"
       xscaled \naturalfigurewidth\space
       yscaled \naturalfigureheight\space
       #2 ;
   \stopMPcode
   \egroup}

\protect \endinput
